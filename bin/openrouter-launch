#!/usr/bin/env bash
#
# openrouter-launch - Launch AI coding tools with OpenRouter
# https://github.com/truefrontier/openrouter-launch
#
# Usage: openrouter-launch [OPTIONS] [INTEGRATION]
#

set -euo pipefail
[[ "${DEBUG:-0}" == "1" ]] && set -x

#######################################
# Constants
#######################################

readonly VERSION="0.1.0"
readonly CONFIG_DIR="$HOME/.openrouter-launch"
readonly CONFIG_FILE="$CONFIG_DIR/config"
readonly OPENROUTER_BASE_URL="https://openrouter.ai/api"

# Model list (name|pricing)
# Using indexed array for bash 3.x compatibility
MODELS=(
    "anthropic/claude-sonnet-4|\$3/\$15 per 1M tokens"
    "anthropic/claude-opus-4|\$15/\$75 per 1M tokens"
    "anthropic/claude-haiku|\$0.25/\$1.25 per 1M tokens"
    "google/gemini-2.0-flash|\$0.10/\$0.40 per 1M tokens"
    "google/gemini-2.5-pro|\$1.25/\$10 per 1M tokens"
    "openai/gpt-4o|\$2.50/\$10 per 1M tokens"
    "openai/gpt-4o-mini|\$0.15/\$0.60 per 1M tokens"
    "deepseek/deepseek-chat-v3|\$0.14/\$0.28 per 1M tokens"
    "meta-llama/llama-3.3-70b-instruct|\$0.30/\$0.40 per 1M tokens"
    "qwen/qwen-2.5-coder-32b-instruct|\$0.20/\$0.20 per 1M tokens"
)

#######################################
# Logging functions (to stderr)
#######################################

log_info() {
    echo "[INFO] $*" >&2
}

log_error() {
    echo "[ERROR] $*" >&2
}

log_success() {
    echo "✓ $*" >&2
}

#######################################
# Dependency validation
#######################################

check_dependencies() {
    local cmd
    for cmd in "$@"; do
        if ! command -v "$cmd" &>/dev/null; then
            log_error "Missing required command: $cmd"
            exit 1
        fi
    done
}

#######################################
# Model alias resolution
#######################################

resolve_alias() {
    local alias="$1"
    case "$alias" in
        sonnet|sonnet4)
            echo "anthropic/claude-sonnet-4"
            ;;
        opus|opus4)
            echo "anthropic/claude-opus-4"
            ;;
        haiku)
            echo "anthropic/claude-haiku"
            ;;
        flash)
            echo "google/gemini-2.0-flash"
            ;;
        gemini|gemini-pro)
            echo "google/gemini-2.5-pro"
            ;;
        gpt4|gpt4o)
            echo "openai/gpt-4o"
            ;;
        gpt4-mini|gpt4o-mini)
            echo "openai/gpt-4o-mini"
            ;;
        deepseek)
            echo "deepseek/deepseek-chat-v3"
            ;;
        llama|llama3)
            echo "meta-llama/llama-3.3-70b-instruct"
            ;;
        qwen|qwen-coder)
            echo "qwen/qwen-2.5-coder-32b-instruct"
            ;;
        *)
            # Not an alias, return as-is
            echo "$alias"
            ;;
    esac
}

# Check if model exists in MODELS array
model_exists() {
    local model="$1"
    local entry
    for entry in "${MODELS[@]}"; do
        local name="${entry%%|*}"
        if [[ "$name" == "$model" ]]; then
            return 0
        fi
    done
    return 1
}

# Get model pricing
get_model_pricing() {
    local model="$1"
    local entry
    for entry in "${MODELS[@]}"; do
        local name="${entry%%|*}"
        local pricing="${entry#*|}"
        if [[ "$name" == "$model" ]]; then
            echo "$pricing"
            return 0
        fi
    done
    echo "unknown pricing"
}

# Resolve model (alias or full name) and validate
resolve_model() {
    local input="$1"
    local resolved

    # Try alias first
    resolved=$(resolve_alias "$input")

    # Check if it exists
    if model_exists "$resolved"; then
        echo "$resolved"
        return 0
    fi

    # Not found
    log_error "Unknown model: $input"
    log_error "Use --help to see available models and aliases"
    return 1
}

#######################################
# Model selection menu
#######################################

show_model_menu() {
    echo "" >&2
    echo "Select a model:" >&2
    echo "" >&2

    local i=1
    local entry
    for entry in "${MODELS[@]}"; do
        local name="${entry%%|*}"
        local pricing="${entry#*|}"
        printf "  %2d) %-40s %s\n" "$i" "$name" "$pricing" >&2
        ((i++))
    done

    echo "" >&2
}

select_model() {
    local selection
    local resolved

    show_model_menu

    while true; do
        printf "Enter number (1-%d) or model name: " "${#MODELS[@]}" >&2
        read -r selection

        # Handle empty input
        if [[ -z "$selection" ]]; then
            log_error "Please enter a selection"
            continue
        fi

        # Check if it's a number
        if [[ "$selection" =~ ^[0-9]+$ ]]; then
            if [[ "$selection" -ge 1 && "$selection" -le "${#MODELS[@]}" ]]; then
                local entry="${MODELS[$((selection-1))]}"
                resolved="${entry%%|*}"
                break
            else
                log_error "Invalid selection. Enter 1-${#MODELS[@]}"
                continue
            fi
        fi

        # Try as model name or alias
        if resolved=$(resolve_model "$selection"); then
            break
        fi
    done

    echo "$resolved"
}

# Prompt to save model as default
maybe_save_default_model() {
    local model="$1"

    # Only prompt if we don't already have a default
    load_config
    if [[ -n "${DEFAULT_MODEL:-}" && "$DEFAULT_MODEL" == "$model" ]]; then
        return 0
    fi

    local save_it
    printf "Save '%s' as default model? [y/N]: " "$model" >&2
    read -r save_it

    if [[ "$save_it" =~ ^[Yy] ]]; then
        DEFAULT_MODEL="$model"
        save_config "$OPENROUTER_API_KEY" "$DEFAULT_MODEL"
    fi
}

#######################################
# Configuration management
#######################################

# Global state
OPENROUTER_API_KEY="${OPENROUTER_API_KEY:-}"
DEFAULT_MODEL="${DEFAULT_MODEL:-}"

load_config() {
    # Create config directory if needed
    if [[ ! -d "$CONFIG_DIR" ]]; then
        mkdir -p "$CONFIG_DIR"
        chmod 700 "$CONFIG_DIR"
    fi

    # Source config if exists
    if [[ -f "$CONFIG_FILE" ]]; then
        # shellcheck source=/dev/null
        source "$CONFIG_FILE"
    fi
}

save_config() {
    local key="$1"
    local default_model="${2:-}"

    # Write config file
    cat > "$CONFIG_FILE" << EOF
# openrouter-launch configuration
# Generated by openrouter-launch v$VERSION

OPENROUTER_API_KEY="$key"
DEFAULT_MODEL="$default_model"
EOF

    # Set secure permissions
    chmod 600 "$CONFIG_FILE"
    log_success "Configuration saved to $CONFIG_FILE"
}

#######################################
# API key management
#######################################

validate_api_key() {
    local key="$1"

    # Basic format validation
    if [[ ! "$key" =~ ^sk-or- ]]; then
        log_error "Invalid API key format (should start with 'sk-or-')"
        return 1
    fi

    # Validate against OpenRouter API
    log_info "Validating API key..."

    local response
    local http_code

    # Make request to OpenRouter API to validate key
    # Using /api/v1/auth/key endpoint which requires valid auth
    http_code=$(curl -s -o /dev/null -w "%{http_code}" \
        -H "Authorization: Bearer $key" \
        "https://openrouter.ai/api/v1/auth/key" 2>/dev/null)

    if [[ "$http_code" == "200" ]]; then
        log_success "API key validated successfully"
        return 0
    elif [[ "$http_code" == "401" ]]; then
        log_error "Invalid API key (authentication failed)"
        return 1
    elif [[ "$http_code" == "000" ]]; then
        log_error "Could not connect to OpenRouter API"
        log_error "Check your internet connection"
        return 1
    else
        log_error "Unexpected response from OpenRouter (HTTP $http_code)"
        return 1
    fi
}

prompt_api_key() {
    # Check if already set in environment
    if [[ -n "${OPENROUTER_API_KEY:-}" ]]; then
        log_info "Using API key from environment"
        return 0
    fi

    # Check if set in config
    load_config
    if [[ -n "${OPENROUTER_API_KEY:-}" ]]; then
        log_info "Using API key from config"
        return 0
    fi

    # Prompt for key
    echo "" >&2
    echo "OpenRouter API key not found." >&2
    echo "Get your key at: https://openrouter.ai/keys" >&2
    echo "" >&2

    local key
    while true; do
        printf "Enter your OpenRouter API key: " >&2
        read -r key

        if [[ -z "$key" ]]; then
            log_error "API key is required"
            continue
        fi

        if validate_api_key "$key"; then
            OPENROUTER_API_KEY="$key"
            break
        fi
    done

    # Ask to save
    local save_it
    printf "Save API key to config? [Y/n]: " >&2
    read -r save_it
    if [[ -z "$save_it" || "$save_it" =~ ^[Yy] ]]; then
        save_config "$OPENROUTER_API_KEY" "${DEFAULT_MODEL:-}"
    fi
}

#######################################
# Claude Code launch
#######################################

check_claude_installed() {
    if ! command -v claude &>/dev/null; then
        log_error "Claude Code not found"
        log_error "Install it from: https://docs.anthropic.com/en/docs/claude-code"
        exit 1
    fi
}

launch_claude() {
    local model="$1"
    shift  # Remove model from args, rest are passthrough

    check_claude_installed

    # Set environment variables for Claude Code
    export ANTHROPIC_BASE_URL="$OPENROUTER_BASE_URL"
    export ANTHROPIC_API_KEY=""
    export ANTHROPIC_AUTH_TOKEN="$OPENROUTER_API_KEY"

    # Set model override if not using default Anthropic model
    if [[ -n "$model" ]]; then
        export ANTHROPIC_MODEL="$model"
    fi

    echo "" >&2
    echo "Launching Claude Code with OpenRouter..." >&2
    echo "  Model: $model" >&2
    echo "  Base URL: $OPENROUTER_BASE_URL" >&2
    echo "" >&2

    # Execute Claude with any additional arguments
    exec claude "$@"
}

#######################################
# Help and version
#######################################

show_version() {
    echo "openrouter-launch version $VERSION"
}

show_usage() {
    cat <<EOF
openrouter-launch - Launch AI coding tools with OpenRouter

USAGE:
    openrouter-launch [OPTIONS] [INTEGRATION]

INTEGRATIONS:
    claude          Launch Claude Code (default)

OPTIONS:
    -m, --model MODEL    Use specific model (name or alias)
    -k, --key KEY        Use API key (overrides saved key)
    --save-default       Save the selected model as default
    -h, --help           Show this help message
    -v, --version        Show version information

MODEL ALIASES:
    sonnet    → anthropic/claude-sonnet-4
    opus      → anthropic/claude-opus-4
    haiku     → anthropic/claude-haiku
    flash     → google/gemini-2.0-flash
    gpt4      → openai/gpt-4o

EXAMPLES:
    openrouter-launch                    # Interactive mode
    openrouter-launch claude             # Launch Claude Code
    openrouter-launch claude -m sonnet   # Use Claude Sonnet
    openrouter-launch -m flash           # Use Gemini Flash

CONFIG:
    Settings saved to: $CONFIG_FILE

For more information: https://openrouter.ai/docs
EOF
}

#######################################
# Main entry point
#######################################

main() {
    local selected_model=""
    local override_key=""
    local integration=""
    local save_default=0
    local model_was_interactive=0
    local passthrough_args=()

    # Parse arguments first (before dependency checks so --help always works)
    while [[ $# -gt 0 ]]; do
        case $1 in
            -h|--help)
                show_usage
                exit 0
                ;;
            -v|--version)
                show_version
                exit 0
                ;;
            -m|--model)
                if [[ -z "${2:-}" ]]; then
                    log_error "Option $1 requires an argument"
                    exit 1
                fi
                selected_model=$(resolve_model "$2") || exit 1
                shift 2
                ;;
            -k|--key)
                if [[ -z "${2:-}" ]]; then
                    log_error "Option $1 requires an argument"
                    exit 1
                fi
                override_key="$2"
                shift 2
                ;;
            --save-default)
                save_default=1
                shift
                ;;
            claude)
                integration="claude"
                shift
                ;;
            --)
                shift
                passthrough_args+=("$@")
                break
                ;;
            -*)
                log_error "Unknown option: $1"
                show_usage
                exit 1
                ;;
            *)
                # Unknown positional arg - treat as passthrough
                passthrough_args+=("$1")
                shift
                ;;
        esac
    done

    # Check dependencies
    check_dependencies curl

    # Handle API key
    if [[ -n "$override_key" ]]; then
        if ! validate_api_key "$override_key"; then
            exit 1
        fi
        OPENROUTER_API_KEY="$override_key"
    else
        prompt_api_key
    fi

    # Handle model selection
    if [[ -z "$selected_model" ]]; then
        # Check for default model in config
        load_config
        if [[ -n "${DEFAULT_MODEL:-}" ]]; then
            log_info "Using default model: $DEFAULT_MODEL"
            selected_model="$DEFAULT_MODEL"
        else
            selected_model=$(select_model)
            model_was_interactive=1
        fi
    fi

    # Save as default if requested via flag
    if [[ $save_default -eq 1 ]]; then
        DEFAULT_MODEL="$selected_model"
        save_config "$OPENROUTER_API_KEY" "$DEFAULT_MODEL"
    # Or prompt if model was selected interactively
    elif [[ $model_was_interactive -eq 1 ]]; then
        maybe_save_default_model "$selected_model"
    fi

    # Default to Claude integration
    integration="${integration:-claude}"

    # Launch based on integration
    case "$integration" in
        claude)
            launch_claude "$selected_model" "${passthrough_args[@]}"
            ;;
        *)
            log_error "Unknown integration: $integration"
            log_error "Supported: claude"
            exit 1
            ;;
    esac
}

main "$@"
